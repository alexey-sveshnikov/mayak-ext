(()=>{"use strict";var e,t={8957:function(e,t,o){var n=this&&this.__createBinding||(Object.create?function(e,t,o,n){void 0===n&&(n=o);var r=Object.getOwnPropertyDescriptor(t,o);r&&!("get"in r?!t.__esModule:r.writable||r.configurable)||(r={enumerable:!0,get:function(){return t[o]}}),Object.defineProperty(e,n,r)}:function(e,t,o,n){void 0===n&&(n=o),e[n]=t[o]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),i=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var o in e)"default"!==o&&Object.prototype.hasOwnProperty.call(e,o)&&n(t,e,o);return r(t,e),t},a=this&&this.__awaiter||function(e,t,o,n){return new(o||(o=Promise))((function(r,i){function a(e){try{s(n.next(e))}catch(e){i(e)}}function l(e){try{s(n.throw(e))}catch(e){i(e)}}function s(e){var t;e.done?r(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(a,l)}s((n=n.apply(e,t||[])).next())}))},l=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const s=i(o(7294)),c=l(o(677)),u=o(1225),d=o(710);t.default=function(e){const[t,o]=(0,s.useState)(!0),n=(0,s.useRef)(null),[r,i]=(0,s.useState)(null),[l,c]=(0,s.useState)([]),g=e.promocode;var b,x,y;b=e=>"Escape"==e.key,x=()=>o(!t),y=[t],(0,s.useEffect)((()=>{const e=e=>{b(e)&&x()};return document.addEventListener("keyup",e),()=>{document.removeEventListener("keyup",e)}}),y);const w=(0,s.useCallback)((()=>{c([]);const e=[];n.current&&setTimeout((()=>{if(!n.current)return;var t;n.current&&(function(e){let t;const o=document.createNodeIterator(e,NodeFilter.SHOW_ALL);for(;t=o.nextNode();)t.removeAttribute&&t.removeAttribute("style")}(t=n.current),function(e){let t;const o=document.createNodeIterator(e,NodeFilter.SHOW_ALL);for(;t=o.nextNode();)"A"==t.tagName&&t.setAttribute("target","_blank")}(t));const{cartItems:o,rejectedRows:r,withCounts:i}=(0,u.extractData)(n.current);i||c(["Не удалось распознать колонку таблицы с количествами – везде будут '1'",...e]);for(const e of o)e.warning&&e.tableRow&&e.tableRow.setAttribute("style","background: orange;");for(const e of r)e.setAttribute("style","background: grey;")}),100)}),[n,l]),_=(0,s.useCallback)((()=>a(this,void 0,void 0,(function*(){}))),[g,l]),k=(0,s.useCallback)((()=>{c([]);const e=[];if(null==n.current)return;const{cartItems:t}=(0,u.extractData)(n.current);0!=t.length?(()=>a(this,void 0,void 0,(function*(){console.log("adding items",t);const o=yield d.lentaAPI.saveCart(t);for(const e of o.rejectedItems)console.log("item is failed to save: ",e),console.log("error was: ",e.error),e.tableRow&&e.tableRow.setAttribute("style","background: #ffb0b0;");if(o.success)return o.validItems.length;{const t=yield d.lentaAPI.saveCart(o.validItems);if(t.success)return t.validItems.length;throw c(["Ошибка при сохранении, должно помочь повторное сохранение",...e]),new Error}})))().then((o=>{c([`Сохранили успешно ${o} товаров из ${t.length}.`,"Товары, которые не удалось сохранить отмечены красным цветом","Изменения в корзине будут видны после перезагрузки страницы",...e]),i(null)})).catch((e=>{i(null),console.log("failed to save",e),alert(`Не удалось сохранить: ${e}`)})):console.log("no data extracted")}),[_]);return s.default.createElement(s.default.StrictMode,null,t&&s.default.createElement(f,{className:"utkonos-ext-root"},s.default.createElement(h,{contentEditable:!0,ref:n,onPaste:w}),s.default.createElement(p,null,g&&s.default.createElement("div",null,"Используется промокод ",g),l.map((e=>s.default.createElement("div",{key:e},e)))),s.default.createElement(m,{onClick:k,disabled:!!r},r&&`Сохраняем... ${r}`,!r&&"Добавить")),s.default.createElement(v,{onClick:()=>o(!t)}))};const f=c.default.div`
  position: fixed;
  width: 400px;
  height: 80vh;
  top: calc(50% - 40vh);
  right: 5px;
  background: #ffd9d9;
  z-index: 1000;
  border: 1px solid #555;
  border-radius: 7px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  overflow: hidden;
`,h=c.default.div`
  height: 100%;
  width: 100%;
  border-radius: 7px;
  background: white;
  overflow: scroll;
  
  font-size: 0.8em;
  
  padding: 5px 10px;
`,p=c.default.div`
  font-size: 10px;
  display: flex;
  flex-direction: column;
  align-items: center;
`,m=c.default.button`
  margin: 5px;
  border: 1px solid black;
  border-radius: 3px;
`,v=c.default.div`
  position: fixed;
  height: 73px;
  width: 36px;
  top: 0;
  right: 0;
  z-index: 1000;
  background: url(https://mayak.help/wp-content/themes/mayak/img/logo.png);
  transform: scale(0.8);
  -webkit-transform-origin-x: right;
  -webkit-transform-origin-y: top;
`},710:function(e,t,o){var n=this&&this.__awaiter||function(e,t,o,n){return new(o||(o=Promise))((function(r,i){function a(e){try{s(n.next(e))}catch(e){i(e)}}function l(e){try{s(n.throw(e))}catch(e){i(e)}}function s(e){var t;e.done?r(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(a,l)}s((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.lentaAPI=t.LentaAPI=void 0;const r=o(5431);class i{saveCart(e){return n(this,void 0,void 0,(function*(){const t=e.map((e=>({skuCode:e.id.toString(),quantity:e.quantity,isPostedFromCartPage:!0}))),[o,n]=yield this.makeRequest("/api/v2/ecom/cart/skus",t);if(200==o)return{success:!0,validItems:e,rejectedItems:[]};{const t=[];for(const o of n){const n=e.find((e=>{var t;return e.id.toString()==(null===(t=o.errorSkus[0])||void 0===t?void 0:t.skuCode)}));n?t.push(Object.assign(Object.assign({},n),{error:o.errorMessage})):console.error("unexpected item in the response data",o)}const r=new Set;for(const e of t)r.add(e.id);return{success:200===o,rejectedItems:t,validItems:e.filter((e=>!r.has(e.id)))}}}))}makeRequest(e,t){return n(this,void 0,void 0,(function*(){const o=yield fetch("https://lenta.com"+e,{headers:{accept:"application/json","accept-language":"en-US,en;q=0.9,ru;q=0.8","content-type":"application/json"},referrer:"https://lenta.com/order/cart/",referrerPolicy:"strict-origin-when-cross-origin",body:JSON.stringify(t),method:"POST",mode:"cors",credentials:"include"});if(o.status>=500)throw new r.StoreException(o.statusText);return[o.status,yield o.json()]}))}}t.LentaAPI=i,t.lentaAPI=new i},5431:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.StoreException=void 0;class o extends Error{constructor(e){super(e),this.name="StoreException"}}t.StoreException=o},5311:function(e,t,o){var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=n(o(7294)),i=n(o(3935)),a=n(o(8957)),l=new URLSearchParams(document.currentScript.src.split("?")[1]).get("promocode")||"";console.log(`[utkonos-ext] initializing (with promocode: "${l}")`);const s=document.createElement("div");document.body.appendChild(s),i.default.render(r.default.createElement(a.default,{promocode:l}),s)},923:(e,t,o)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.extractFromTable=void 0;const n=o(9385);o(8446),o(4788),o(6026),t.extractFromTable=function(e){var t;const[o,r]=function(e){const t=(0,n.doXpath)(".//tr",e),o=[];for(const e of t){const t=[];for(const o of e.childNodes){const e=document.evaluate(".//a",o,null,XPathResult.ANY_TYPE).iterateNext();if(null!==e){const o=e instanceof HTMLElement?e.getAttribute("href"):e.textContent;t.push(o||"")}else t.push(o.textContent||"")}o.push(t)}return[o,t]}(e);if(0==o.length)return{cartItems:[],rejectedRows:[]};console.log("table data"),console.table(o);const i=function(e){var t;let o=e.map((e=>e.map((e=>e.replace(/\s*(штук|шт)\.?\s*/gi,"")))));o=o.filter((e=>e.filter((e=>!isNaN(parseFloat(null==e?void 0:e.trim())))).length>0));const n=Math.round(o.map((e=>e.filter((e=>!!(null==e?void 0:e.trim()))).length)).reduce(((e,t)=>e+t),0)/o.length);o=o.filter((e=>e.filter((e=>!!(null==e?void 0:e.trim()))).length==n)),console.log("Detecting quantities column. This is the filtered data"),console.table(o);for(let e=0;e<(null===(t=o[0])||void 0===t?void 0:t.length);e++){const t=o.map((t=>t[e])),n=t.map((e=>parseFloat(null==e?void 0:e.trim())));if(void 0!==n.find(isNaN)){console.log(`column ${e} is not all numbers`);continue}if(n.every(((e,t)=>0===t||e>n[t-1]))){console.log(`column ${e} looks like a row numbers`);continue}const r=n.reduce(((e,t)=>e+t),0)/t.length,i=n.filter((e=>Math.round(e)==e)).length/t.length;if(r<15&&i>.5)return console.log(`column ${e} seems to have a quantities`),e;console.log(`column ${e} ignored. Average value: ${r}, rate of rounded values: ${i})`)}}(o);if(void 0===i)return console.log("can't find quantities column"),{cartItems:[],rejectedRows:[]};const a=[],l=[];for(let e=0;e<o.length;e++){const n=o[e];if(0==n.filter((e=>!isNaN(parseFloat(null==e?void 0:e.trim())))).length){console.log("filter out possible header of footer row: ",n);continue}let s=!1,c=parseInt(n[i]);c||(console.log(`can't parse quantity from column ${i}. Using default value. Row: `,n),c=1,s=!0);const u=n.find((e=>-1!=e.indexOf("utkonos.ru")));if(!u){console.log("can't find link for this row",n),l.push(r[e]);continue}const d=parseInt((null===(t=u.match(/utkonos\.ru\/item\/(\d+)/))||void 0===t?void 0:t[1])||"");d?a.push({id:d,quantity:c,tableRow:r[e],warning:s}):(console.log(`can't find ID for this link: ${u}, row: `,n),l.push(r[e]))}return{cartItems:a,rejectedRows:l}}},3187:(e,t,o)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.extractFromUnstructuredText=void 0;const n=o(9385);t.extractFromUnstructuredText=function(e){const t=[],o=(0,n.doXpath)(".//a",e);for(const e of o)if(e instanceof HTMLElement){const o=e.getAttribute("href");o&&t.push(o)}const r=t.join("\n")+e.textContent,i=[],a=new Set;for(const e of r.matchAll(/utkonos\.ru\/item\/(\d+)/g)){const t=e[1];a.has(t)||(a.add(t),i.push({id:parseInt(t),quantity:1}))}return i}},1225:(e,t,o)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.extractData=void 0;const n=o(923),r=o(3187);t.extractData=function(e){if(1==document.evaluate("count(.//table)",e,null,XPathResult.NUMBER_TYPE).numberValue){const{cartItems:t,rejectedRows:o}=(0,n.extractFromTable)(e);if(t.length>0)return{withCounts:!0,cartItems:t,rejectedRows:o}}return{cartItems:(0,r.extractFromUnstructuredText)(e),rejectedRows:[],withCounts:!1}}},9385:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.doXpath=void 0,t.doXpath=function(e,t,o=XPathResult.ORDERED_NODE_ITERATOR_TYPE){const n=[],r=document.evaluate(e,t,null,XPathResult.ORDERED_NODE_ITERATOR_TYPE);let i=r.iterateNext();for(;i;)i instanceof HTMLElement&&n.push(i),i=r.iterateNext();return n}}},o={};function n(e){var r=o[e];if(void 0!==r)return r.exports;var i=o[e]={id:e,loaded:!1,exports:{}};return t[e].call(i.exports,i,i.exports,n),i.loaded=!0,i.exports}n.m=t,e=[],n.O=(t,o,r,i)=>{if(!o){var a=1/0;for(u=0;u<e.length;u++){for(var[o,r,i]=e[u],l=!0,s=0;s<o.length;s++)(!1&i||a>=i)&&Object.keys(n.O).every((e=>n.O[e](o[s])))?o.splice(s--,1):(l=!1,i<a&&(a=i));if(l){e.splice(u--,1);var c=r();void 0!==c&&(t=c)}}return t}i=i||0;for(var u=e.length;u>0&&e[u-1][2]>i;u--)e[u]=e[u-1];e[u]=[o,r,i]},n.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return n.d(t,{a:t}),t},n.d=(e,t)=>{for(var o in t)n.o(t,o)&&!n.o(e,o)&&Object.defineProperty(e,o,{enumerable:!0,get:t[o]})},n.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),n.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.nmd=e=>(e.paths=[],e.children||(e.children=[]),e),n.j=575,(()=>{var e={575:0};n.O.j=t=>0===e[t];var t=(t,o)=>{var r,i,[a,l,s]=o,c=0;if(a.some((t=>0!==e[t]))){for(r in l)n.o(l,r)&&(n.m[r]=l[r]);if(s)var u=s(n)}for(t&&t(o);c<a.length;c++)i=a[c],n.o(e,i)&&e[i]&&e[i][0](),e[i]=0;return n.O(u)},o=self.webpackChunkutkonos_ext=self.webpackChunkutkonos_ext||[];o.forEach(t.bind(null,0)),o.push=t.bind(null,o.push.bind(o))})(),n.nc=void 0;var r=n.O(void 0,[736],(()=>n(5311)));r=n.O(r)})();